---
title: "Part1"
author: "Oliver Brown"
output: html_document
---

```{r setup, include=FALSE}

if (!requireNamespace("DBI", quietly = TRUE) ||
    !requireNamespace("RSQLite", quietly = TRUE) ||
    !requireNamespace("Lahman", quietly = TRUE) || 
    !requireNamespace("tidymodels", quietly = TRUE)) {
  install.packages(c("DBI", "RSQLite", "Lahman", "tidymodels"))
}

library(DBI)
library(RSQLite)
library(Lahman)
library(dplyr)
library(tidymodels)

con <- dbConnect(RSQLite::SQLite(), "project_3_baseball.db")

data("People")
data("Salaries")
data("Batting")
data("Pitching")

if(!dbExistsTable(con, "people")) dbWriteTable(con, "people", People)
if(!dbExistsTable(con, "salaries")) dbWriteTable(con, "salaries", Salaries)
if(!dbExistsTable(con, "batting")) dbWriteTable(con, "batting", Batting)
if(!dbExistsTable(con, "pitching")) dbWriteTable(con, "pitching", Pitching)

```

# Part 1

## Research Question

How do player performance metrics relate to salary classifications in Major League Baseball over the past decade, and can we predict whether a player is a "Star" based on these metrics?

### Part 1A

```{r part1A}

# Query 1

query_dist <- "
SELECT 
  yearID,
  MIN(salary) as min_sal,
  AVG(salary) as avg_sal,
  MAX(salary) as max_sal
FROM salaries
WHERE yearID = 2015
GROUP BY yearID
ORDER BY yearID DESC
"

dbGetQuery(con, query_dist)
# Based on this, we see Average is around $4 million for the last decade.

# Query 2

query_compare <- "
SELECT 
  CASE 
    WHEN s.salary > 4000000 THEN 'Star_Salary'
    ELSE 'Role_Player' 
  END as Status,
  AVG(b.HR) as Avg_HomeRuns,
  AVG(b.H) as Avg_Hits,
  COUNT(*) as Player_Count
FROM salaries s
JOIN batting b ON s.playerID = b.playerID AND s.yearID = b.yearID
WHERE s.yearID >= 2010
GROUP BY Status;
"
dbGetQuery(con, query_compare)

# Query 3

query_geo <- "
SELECT 
  birthCountry,
  COUNT(playerID) as Total_Players,
  SUM(Is_Star) as Unique_Stars,
  ROUND(100.0 * SUM(Is_Star) / COUNT(playerID), 1) as Percent_Stars
FROM (
  SELECT 
    p.birthCountry,
    p.playerID,
    MAX(CASE WHEN s.salary > 4000000 THEN 1 ELSE 0 END) as Is_Star
  FROM people p
  JOIN salaries s ON p.playerID = s.playerID
  WHERE s.yearID >= 2010
  GROUP BY p.birthCountry, p.playerID
)
GROUP BY birthCountry
HAVING Total_Players > 10
ORDER BY Unique_Stars DESC
LIMIT 5;
"

print(dbGetQuery(con, query_geo))

# Feature Engineering

# Query 4

feat_target_sql <- "
SELECT 
  playerID, 
  salary,
  CASE 
    WHEN salary > 4000000 THEN 1 
    ELSE 0 
  END as Is_Star
FROM salaries
WHERE yearID = 2015
LIMIT 5;
"
dbGetQuery(con, feat_target_sql)

# Query 5

feat_lag_sql <- "
SELECT 
  b1.playerID,
  b1.yearID,
  b1.H as Current_Hits,
  COALESCE(b2.H, 0) as Previous_Hits
FROM batting b1
LEFT JOIN batting b2 
  ON b1.playerID = b2.playerID 
  AND b1.yearID = (b2.yearID + 1)
WHERE b1.yearID = 2015
LIMIT 5;
"
print(dbGetQuery(con, feat_lag_sql))

# Query for visualization and modelling

master_query <- "
SELECT 
  s.yearID,
  s.playerID,
  CASE 
    WHEN s.salary > 4000000 THEN 'Star' 
    ELSE 'Normal' 
  END as Salary_Class,
  (s.yearID - p.birthYear) as Age,
  COALESCE(SUM(b.HR), 0) as HR,
  COALESCE(SUM(b.H), 0) as Hits,
  COALESCE(SUM(b.RBI), 0) as RBI,
  COALESCE(SUM(pit.W), 0) as Wins,
  COALESCE(SUM(pit.SV), 0) as Saves,
  COALESCE(SUM(pit.SO), 0) as Pitching_SO,
  COALESCE(
    (SELECT SUM(b2.HR) FROM batting b2 WHERE b2.playerID = s.playerID AND b2.yearID = s.yearID - 1), 
    0
  ) as Previous_HR,
  COALESCE(
    (SELECT SUM(pit2.W) FROM pitching pit2 WHERE pit2.playerID = s.playerID AND pit2.yearID = s.yearID - 1), 
    0
  ) as Previous_Wins
FROM salaries s
JOIN people p ON s.playerID = p.playerID
LEFT JOIN batting b ON s.playerID = b.playerID AND s.yearID = b.yearID
LEFT JOIN pitching pit ON s.playerID = pit.playerID AND s.yearID = pit.yearID
WHERE s.yearID >= 2010
GROUP BY s.yearID, s.playerID, s.salary, p.birthYear
"

class_data <- dbGetQuery(con, master_query)
class_data <- na.omit(class_data)
head(class_data, 5)

# Visualization
ggplot(class_data, aes(x = Salary_Class, y = HR, fill = Salary_Class)) +
  geom_boxplot() +
  labs(title = "Do Home Runs determine Salary Class?",
       subtitle = "Stars generally have higher medians, but there is overlap",
       x = "Salary Classification",
       y = "Home Runs") +
  theme_minimal()

```

# Part 1B

```{r part1B}

set.seed(123)

class_data$Salary_Class <- as.factor(class_data$Salary_Class)

data_split <- initial_split(class_data, prop = 0.70, strata = Salary_Class)
train_data <- training(data_split)
test_data  <- testing(data_split)

ml_recipe <- recipe(Salary_Class ~ Age + HR + Hits + RBI + Previous_HR + 
                     Wins + Saves + Pitching_SO + Previous_Wins, 
                    data = train_data) %>%
  step_normalize(all_numeric_predictors())

log_spec <- logistic_reg() %>%
  set_engine("glm") %>%
  set_mode("classification")

ml_workflow <- workflow() %>%
  add_recipe(ml_recipe) %>%
  add_model(log_spec)

ml_fit <- ml_workflow %>% 
  fit(data = train_data)

results <- ml_fit %>%
  predict(test_data) %>%
  bind_cols(predict(ml_fit, test_data, type = "prob")) %>%
  bind_cols(test_data)

results %>% accuracy(truth = Salary_Class, estimate = .pred_class, event_level = "second")
results %>% roc_auc(truth = Salary_Class, .pred_Star, event_level = "second")

results %>%
  roc_curve(truth = Salary_Class, .pred_Star, event_level = "second") %>%
  autoplot()

tidy(ml_fit) %>%
  filter(term != "(Intercept)") %>%
  mutate(odds_ratio = exp(estimate)) %>%
  select(term, estimate, odds_ratio, p.value) %>%
  arrange(p.value)

```

ACC $\approx$ 0.83

AUC $\approx$ 0.87

## Conclusion



